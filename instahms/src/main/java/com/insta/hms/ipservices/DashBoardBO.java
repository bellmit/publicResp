/**
 * @author sirisha.rachkonda
 */

package com.insta.hms.ipservices;

import com.bob.hms.adminmasters.services.MasterServicesDao;
import com.bob.hms.common.DataBaseUtil;
import com.insta.hms.billing.Bill;
import com.insta.hms.billing.BillBO;
import com.insta.hms.billing.ChargeDAO;
import com.insta.hms.billing.ChargeDTO;
import com.insta.hms.master.DietaryMaster.DietaryMasterDAO;
import com.insta.hms.orders.OrderBO;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.math.BigDecimal;
import java.sql.Connection;
import java.sql.SQLException;
import java.text.SimpleDateFormat;
import java.util.List;
import java.util.Map;

// TODO: Auto-generated Javadoc
/**
 * The Class DashBoardBO.
 */
public class DashBoardBO {

  /** The logger. */
  static Logger logger = LoggerFactory.getLogger(DashBoardBO.class);
  
  /** The dao. */
  DashBoardDAO dao = new DashBoardDAO();

  /**
   * Registering a New Born Baby.
   *
   * @param dto the dto
   * @param billno the billno
   * @param userid the userid
   * @param centerId the center id
   * @return result
   * @throws Exception the exception
   */
  public boolean register(NewBornDTO dto, String billno, String userid, int centerId)
      throws Exception {
    Connection con = null;
    boolean result = true;

    try {
      con = DataBaseUtil.getConnection();
      con.setAutoCommit(false);
      BedAdmissionDTO admitDto = new BedAdmissionDTO();
      result = dao.register(con, dto, userid, centerId);

      java.util.Date admDate = new java.util.Date();
      SimpleDateFormat sdf = new SimpleDateFormat("dd-MM-yyyy");
      String dateStr = sdf.format(admDate);

      if (!dto.getBedtype().equalsIgnoreCase("")) { // new bed for baby
        // -- bed allocation
        admitDto.setAdmitwardid(dto.getPatientWard());
        admitDto.setMrNo(dto.getAutogeneratedmrno());
        admitDto.setPatientid(dto.getAutogeneratedpatient());
        admitDto.setParentId(dto.getPatientid());
        admitDto.setEstimateddays(0);
        admitDto.setPatientorg(dto.getPatientorg());
        admitDto.setIsBaby("Y");
        admitDto.setDaycare("N");
        admitDto.setAdmitPatDeptId(dto.getPatientDept());

        if (result) {
          result = insertRegistartionCharges(con, dto, userid);
        }
        if (result) {
          result = dao.admitPatient(con, admitDto, dateStr, DataBaseUtil.getDateandTime(), "Y",
              false, "Days", null);
        }

      } else { // baby shares mother's bed -- no bed allocation
        admitDto.setAdmitbednumber("Allocate Bed");
        admitDto.setAdmitward(dto.getPatientWard());
        admitDto.setMrNo(dto.getAutogeneratedmrno());
        admitDto.setPatientid(dto.getAutogeneratedpatient());
        admitDto.setParentId(dto.getPatientid());
        admitDto.setEstimateddays(0); // temporary arrangement
        admitDto.setIsBaby("Y");
        admitDto.setDaycare("N");
        admitDto.setAdmitPatDeptId(dto.getPatientDept());
        if (result) {
          result = insertRegistartionCharges(con, dto, userid);
        }
        if (result) {
          result = dao.admitPatient(con, admitDto, dateStr, DataBaseUtil.getDateandTime(), "Y",
              false, "Days", null);
        }
      }

    } catch (Exception ex) {
      result = false;
      throw ex;
    } finally {
      if (con != null) {
        if (result) {
          con.commit();
        } else {
          con.rollback();
        }
        con.close();
      }
    }
    return result;
  }

  /**
   * Method to insert registration charges for New Born Baby.
   *
   * @param con the con
   * @param dto the dto
   * @param userid the userid
   * @return result
   * @throws Exception the exception
   */
  private boolean insertRegistartionCharges(Connection con, NewBornDTO dto, String userid)
      throws Exception {

    String billToUse = null;
    boolean result = true;

    String timestamp = DataBaseUtil
        .getStringValueFromDb("select to_char(localtimestamp(0), 'dd-mm-yyyy hh24:mi')");
    SimpleDateFormat dateFormat = new SimpleDateFormat("dd-MM-yyyy HH:mm");
    java.util.Date parsedDate = (java.util.Date) dateFormat.parse(timestamp);
    java.sql.Timestamp datetime = new java.sql.Timestamp(parsedDate.getTime());

    if (dto.getBilltype().equalsIgnoreCase("P")) {
      String prepaidBill = null;
      Bill bill = new Bill();
      bill.setVisitId(dto.getAutogeneratedpatient());
      bill.setVisitType("i");
      bill.setBillType(Bill.BILL_TYPE_PREPAID);
      bill.setStatus(Bill.BILL_STATUS_OPEN);
      bill.setOpenedBy(userid);
      bill.setUserName(userid);
      bill.setOpenDate(parsedDate);
      bill.setDepositSetOff(BigDecimal.ZERO);
      bill.setOkToDischarge(Bill.BILL_DISCHARGE_NOTOK);
      bill.setBillRatePlanId(dto.getPatientorg());

      Map msgMap = new BillBO().createNewBill(con, bill, false);
      if (msgMap.get("error") != null && !msgMap.get("error").equals("")) {
        result = false;
        return result;
      } else {
        prepaidBill = bill.getBillNo();
      }

      billToUse = prepaidBill;
      dto.setBillno(billToUse);

    } else { // for bill later credit bill
      String creditBillNo = null;
      Bill bill = new Bill();

      bill.setVisitId(dto.getAutogeneratedpatient());
      bill.setVisitType("i");
      bill.setBillType(Bill.BILL_TYPE_CREDIT);
      bill.setStatus(Bill.BILL_STATUS_OPEN);
      bill.setOpenedBy(userid);
      bill.setUserName(userid);
      bill.setOkToDischarge(Bill.BILL_DISCHARGE_NOTOK);
      bill.setOpenDate(datetime);
      bill.setDepositSetOff(BigDecimal.ZERO);
      bill.setBillRatePlanId(dto.getPatientorg());

      Map msgMap = new BillBO().createNewBill(con, bill, false);
      if (msgMap.get("error") != null && !msgMap.get("error").equals("")) {
        result = false;
        return result;
      } else {
        creditBillNo = bill.getBillNo();
      }

      billToUse = creditBillNo;
      dto.setBillno(billToUse);
    }

    List<ChargeDTO> charges = OrderBO.getRegistrationCharges(dto.getBedtype(), dto.getPatientorg(),
        "GREG", false, false, 0, true, "i", dto.getAutogeneratedpatient(), con, null); 
    // true: skip if charge is 0.
    // add IPREG charges
    charges.addAll(OrderBO.getRegistrationCharges(dto.getBedtype(), dto.getPatientorg(), "IPREG",
        false, false, 0, true, "i", dto.getAutogeneratedpatient(), con, null)); 
    // true: skip if charge is 0.

    ChargeDAO cdao = new ChargeDAO(con);
    for (ChargeDTO chrg : charges) {
      chrg.setChargeId(cdao.getNextChargeId());
      chrg.setBillNo(billToUse);
      chrg.setUsername(userid);
    }

    result = cdao.insertCharges(charges);
    return result;
  }

  /**
   * Gets the test dept charges.
   *
   * @param bedtype the bedtype
   * @param orgid the orgid
   * @return the test dept charges
   * @throws SQLException the SQL exception
   */
  public List getTestDeptCharges(String bedtype, String orgid) throws SQLException {
    return DashBoardDAO.getTestDeptCharges(bedtype, orgid);

  }

  /**
   * Gets the service dept charges.
   *
   * @param bedtype the bedtype
   * @param orgid the orgid
   * @param dialysisModule the dialysis module
   * @return the service dept charges
   * @throws SQLException the SQL exception
   */
  public List getServiceDeptCharges(String bedtype, String orgid, String dialysisModule)
      throws SQLException {
    MasterServicesDao dao = new MasterServicesDao();
    return dao.getServiceDeptCharges(bedtype, orgid, dialysisModule);
  }

  /**
   * Gets the meal charges.
   *
   * @param bedType the bed type
   * @param orgID the org ID
   * @return the meal charges
   * @throws SQLException the SQL exception
   */
  // For dietary
  public List getMealCharges(String bedType, String orgID) throws SQLException {
    DietaryMasterDAO dao = new DietaryMasterDAO();
    return dao.getMealCharge(bedType, orgID);
  }

  /**
   * Gets the equipment dept charges.
   *
   * @param bedtype the bedtype
   * @param orgid the orgid
   * @return the equipment dept charges
   * @throws SQLException the SQL exception
   */
  public List getEquipmentDeptCharges(String bedtype, String orgid) throws SQLException {
    return DashBoardDAO.getEquipmentDeptCharges(bedtype, orgid);
  }

  /**
   * Gets the operation dept charges.
   *
   * @param bedtype the bedtype
   * @param orgid the orgid
   * @return the operation dept charges
   * @throws SQLException the SQL exception
   */
  public List getOperationDeptCharges(String bedtype, String orgid) throws SQLException {
    return DashBoardDAO.getOperationDeptCharges(bedtype, orgid);
  }

}
