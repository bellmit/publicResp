package com.insta.hms.common;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;

/**
 * The Class ConsultationTokenGenerator to generate patient consultation tokens which vary for each
 * doctor. Next token is generated by updating patient_consultation_tokens for that doctor and
 * returning the incremented value.
 */
@Component
public class ConsulationTokenGenerator {
  /** The Constant logger. */
  private static final Logger log = LoggerFactory.getLogger(ConsulationTokenGenerator.class);

  /**
   * Generate token.
   *
   * @param doctor the doctor
   * @return the int
   */
  public int generateToken(String doctor) {
    return getNextToken(doctor);
  }

  /** The Constant NEXT_TOKEN_QUERY. */
  private static final String NEXT_TOKEN_QUERY = "UPDATE doctor_consultation_tokens"
      + " SET consultation_token = consultation_token + 1 WHERE doctor_id = ?"
      + " RETURNING consultation_token;";

  /** The Constant OP_GENERATE_TOKEN_ENABLED_QUERY. */
  private static final String OP_GENERATE_TOKEN_ENABLED_QUERY = 
      "SELECT op_generate_token FROM registration_preferences";

  /**
   * Gets the next token.
   *
   * @param doctor the doctor
   * @return the next token
   */
  private static int getNextToken(String doctor) {
    Integer token = DatabaseHelper.getJBDCTemplate().execute(NEXT_TOKEN_QUERY,
        new ConsultationTokenCallback(doctor));

    if (log.isDebugEnabled()) {
      log.debug("Token [" + token + "] generated for doctor " + doctor);
    }
    return token;
  }

  /**
   * Checks if is token generation enabled.
   *
   * @return true, if is token generation enabled
   */
  public boolean isTokenGenerationEnabled() {
    String generateToken = DatabaseHelper.getString(OP_GENERATE_TOKEN_ENABLED_QUERY);
    return generateToken.equals("Y");
  }
}
