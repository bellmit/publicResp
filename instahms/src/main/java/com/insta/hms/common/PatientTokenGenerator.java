package com.insta.hms.common;

import com.bob.hms.common.DataBaseUtil;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

/**
 * The Class PatientTokenGenerator to generate patient consultation tokens which vary for each
 * doctor. Next token is generated by updating patient_consultation_tokens for that doctor and
 * returning the incremented value.
 */
public class PatientTokenGenerator {
  /** The Constant logger. */
  private static final Logger log = LoggerFactory.getLogger(PatientTokenGenerator.class);

  /**
   * Generate token.
   *
   * @param doctor the doctor
   * @return the int
   * @throws SQLException the SQL exception
   */
  public static int generateToken(String doctor) throws java.sql.SQLException {
    return getNextToken(doctor);
  }

  /** The Constant NEXT_TOKEN_QUERY. */
  private static final String NEXT_TOKEN_QUERY = "UPDATE doctor_consultation_tokens"
      + " SET consultation_token = consultation_token + 1 WHERE doctor_id = ?"
      + " RETURNING consultation_token;";

  private static int getNextToken(String doctor) throws java.sql.SQLException {
    Integer token = null;
    Connection connection = null;
    PreparedStatement preparedStatement = null;
    try {
      connection = DataBaseUtil.getConnection();
      preparedStatement = connection.prepareStatement(NEXT_TOKEN_QUERY);
      preparedStatement.setObject(1, doctor);
      ResultSet result = preparedStatement.executeQuery();
      while (result.next()) {
        token = result.getInt(1);
        if (log.isDebugEnabled()) {
          log.debug("Token [" + token + "] generated for doctor " + doctor);
        }
      }
    } finally {
      DataBaseUtil.closeConnections(connection, preparedStatement);
    }

    return token;
  }
}
