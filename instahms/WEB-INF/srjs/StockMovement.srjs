{
    "title": "Stock Movement Report",
    "reportGroup": "Stores Reports",
    "dateFields": [
        "txn_date"
    ],
    "description": "This report builder gives details of store-wise opening and closing balances based on the date range selected. The Report is to be read as Opening Stock + Net Qty = Closing Stock. The Net Qty is a cumulative addition of all purchases - consumption via transactions which include Supplier Returns, Sales, Issues, Transfers, Adjustments, Reagents / Bulk Consumption. The transit stock and rejected stock which arise in the process of Stock Transfer Indenting are not included as part of Net Qty calculation.",
    "comment": [
        "This report pre-groups the movement across the selected period. It is equivalent",
        "to a tabular summary of the Stock Consumption report. Since daily numbers are not important, ",
        "the pre-grouping makes a lot of difference in performance.",
        "Other differences is in the fields: here we only have net qty (instead of incr/decr as separate)",
        "and we also have MRP/CP value over and above qty. Further, we also have closing/opening stock.",
        "Field names for each component:",
        "  1st letter: o/m/f/d/c : opening/movement/final/difference/current ",
        "  2nd letter: p/r/s/i/t/a/g/_/n/j : purchases/repl-returns/sales/issue/transfer/adj/rea(g)ents/total/net/re(j)ected",
        "  3rd letter: q/c/m : quantity/cost-value/mrp-value",
        "     (Purchases is inward amount/qty, the rest are outward amount/qty.) ",
        "Strategy: we get m,d,c from DB. We are interested in o,m,f. So, o and f have to be calculated.",
        "  from          to    cur ",
        "   |.............|......| ",
        "   o<-----m----->f      c ",
        "   <---------d----------> ",
        "  o = c - d ",
        "  f = o + m  = c - d + m"
    ],
    "queryLines": [
        [
            " SELECT dept_name, center_name, medicine_name,cust_item_code, category, gn.generic_name, store_type_name, service_sub_group_name, service_group_name,ifm.item_form_name,sid.issue_units as issue_uom,sid.package_uom, ",
            "   sum(c_q -dpq+drq+dsq+diq+(dtq)+daq+dgq) o_q, ",
            "   sum(mpq) mpq, sum(mrq) mrq, sum(msq) msq, sum(miq) miq, sum(mtq) mtq, sum(maq) maq, sum(mgq) mgq, sum(mnq) mnq, sum(mjq) mjq, ",
            "   sum(mpq-mrq-msq-miq-(mtq)-maq-mgq) m_q, ",
            "   sum(c_q -dpq+drq+dsq+diq+(dtq)+daq+dgq +mpq-mrq-msq-miq-(mtq)-maq-mgq) f_q, ",
            "   sum(c_c -dpc+drc+dsc+dic+(dtc)+dac+dgc) o_c, ",
            "   sum(mpc) mpc, sum(mrc) mrc, sum(msc) msc, sum(mic) mic, sum(mtc) mtc, sum(mac) mac, sum(mgc) mgc, sum(mnc) mnc, sum(mjc) mjc, ",
            "   sum(mpc-mrc-msc-mic-(mtc)-mac-mgc) m_c, ",
            "   sum(c_c -dpc+drc+dsc+dic+(dtc)+dac+dgc +mpc-mrc-msc-mic-(mtc)-mac-mgc) f_c, ",
            "   sum(c_m -(dpm-drm)+dsm+dim+(dtm)+dam+dgm) o_m, ",
            "   sum(mpm) mpm, sum(mrm) mrm, sum(msm) msm, sum(mim) mim, sum(mtm) mtm, sum(mam) mam, sum(mgm) mgm, sum(mnm) mnm, sum(mjm) mjm, ",
            "   sum(mpm-mrm-msm-mim-(mtm)-mam-mgm) m_m, ",
            "   sum(c_m -dpm+drm+dsm+dim+(dtm)+dam+dgm +mpm-mrm-msm-mim-(mtm)-mam-mgm) f_m ",
            " FROM ( ",
            "   -- purchases , purchases returns and debit_qty from store_grn_details ",
            "   SELECT store_id, g.medicine_id, ",
            "     sum(CASE WHEN date(grn_date) <= ${toDate} THEN ",
            "       (g.billed_qty + g.bonus_qty) ELSE 0 END) as mpq, ",
            "     sum(g.billed_qty + g.bonus_qty) as dpq, ",
            "     sum(CASE WHEN date(grn_date) <= ${toDate} THEN  ",
            "      g.cost_value ELSE 0 END) as mpc, ",
            "    sum(g.cost_value)  as dpc, ",
            "     sum(CASE WHEN date(grn_date) <= ${toDate} THEN  ",
            "       (g.billed_qty + g.bonus_qty)*sibd.mrp/isid.issue_base_unit ELSE 0 END) as mpm, ",
            "     sum((g.billed_qty + g.bonus_qty)*sibd.mrp/isid.issue_base_unit) as dpm, ",
            "     0 as mrq, 0 as drq, 0 as mrc, 0 as drc, 0 as mrm, 0 as drm, ",
            "     0 as msq, 0 as dsq, 0 as msc, 0 as dsc, 0 as msm, 0 as dsm, ",
            "     0 as miq, 0 as diq, 0 as mic, 0 as dic, 0 as mim, 0 as dim, ",
            "     0 as mtq, 0 as dtq, 0 as mtc, 0 as dtc, 0 as mtm, 0 as dtm, ",
            "     0 as maq, 0 as daq, 0 as mac, 0 as dac, 0 as mam, 0 as dam, ",
            "     0 as mgq, 0 as dgq, 0 as mgc, 0 as dgc, 0 as mgm, 0 as dgm, ",
            "    0 as mnq, 0 as dnq, 0 as mnc, 0 as dnc, 0 as mnm, 0 as dnm, ",
            "    0 as mjq, 0 as djq, 0 as mjc, 0 as djc, 0 as mjm, 0 as djm, ",
            "     0 as c_q, 0 as c_c, 0 as c_m ",
            "   FROM store_grn_details g JOIN store_grn_main gm USING (grn_no)  ",
            "    JOIN store_item_batch_details sibd USING(item_batch_id)",
            "    JOIN store_item_details isid ON (isid.medicine_id = g.medicine_id)",
            "   WHERE date(grn_date) >= ${fromDate} ",
            "   GROUP BY store_id, g.medicine_id ",
            "  ",
            "   UNION ALL ",
            "   -- Supplier returns ",
            "   SELECT store_id, ps.medicine_id, ",
            "     0 as mpq, 0, 0, 0, 0, 0, ",
            "     sum(CASE WHEN date(date_time) <= ${toDate} THEN (ps.qty) ELSE 0 END) as mrq, ",
            "     sum(ps.qty) as drq, ",
            "     sum(CASE WHEN date(date_time) <= ${toDate} THEN  ",
            "       ps.cost_value ELSE 0 END) as mrc, ",
            "     sum(ps.cost_value) as drc, ",
            "     sum(CASE WHEN date(date_time) <= ${toDate} THEN  ",
            "       (ps.qty)*sibd.mrp/isid.issue_base_unit ELSE 0 END) as mrm, ",
            "     sum((ps.qty)*sibd.mrp/isid.issue_base_unit) as drm, ",
            "     0 as msq, 0, 0, 0, 0, 0, ",
            "     0 as miq, 0, 0, 0, 0, 0, ",
            "     0 as mtq, 0, 0, 0, 0, 0, ",
            "     0 as maq, 0, 0, 0, 0, 0, ",
            "     0 as mgq, 0, 0, 0, 0, 0, ",
            "    0 as mnq, 0, 0, 0, 0, 0, ",
            "    0 as mjq, 0, 0, 0, 0, 0, ",
            "     0 as c_q, 0, 0",
            "   FROM store_supplier_returns ps ",
            "     JOIN store_supplier_returns_main psm ON (ps.return_no=psm.return_no) ",
            "    JOIN store_item_batch_details sibd USING(item_batch_id)",
            "    JOIN store_item_details isid ON (isid.medicine_id = sibd.medicine_id)",
            "   WHERE date(psm.date_time) >= ${fromDate} ",
            "   GROUP BY store_id, ps.medicine_id ",
            "  ",
            "   UNION ALL ",
            "   -- sales and sales returns from store_sales_details ",
            "   SELECT store_id, ss.medicine_id, ",
            "     0 as mpq, 0, 0, 0, 0, 0, ",
            "     0 as mrq, 0, 0, 0, 0, 0, ",
            "     sum(CASE WHEN date(sale_date) <= ${toDate} THEN quantity ELSE 0 END) as msq, ",
            "     sum(quantity) as dsq, ",
            "     sum(CASE WHEN date(sale_date) <= ${toDate} THEN ss.cost_value ELSE 0 END) as msc, ",
            "     sum(ss.cost_value) as dsc, ",
            "     sum(CASE WHEN date(sale_date) <= ${toDate} THEN quantity*sibd.mrp/isid.issue_base_unit ",
            "       ELSE 0 END) as msm, ",
            "     sum(quantity*sibd.mrp/isid.issue_base_unit) as dsm, ",
            "     0 as miq, 0, 0, 0, 0, 0, ",
            "     0 as mtq, 0, 0, 0, 0, 0, ",
            "     0 as maq, 0, 0, 0, 0, 0, ",
            "     0 as mgq, 0, 0, 0, 0, 0, ",
            "    0 as mnq, 0, 0, 0, 0, 0, ",
            "    0 as mjq, 0, 0, 0, 0, 0, ",
            "     0 as c_q, 0, 0 ",
            "   FROM store_sales_details ss JOIN store_sales_main sm USING(sale_id) ",
            "    JOIN store_item_batch_details sibd ON ( sibd.item_batch_id = ss.item_batch_id)",
            "    JOIN store_item_details isid ON (isid.medicine_id = ss.medicine_id)",
            "   WHERE date(sm.sale_date) >= ${fromDate} ",
            "   GROUP BY sm.store_id, ss.medicine_id ",
            "  ",
            "   UNION ALL ",
            "   -- User issues ",
            "   SELECT dept_from, sid.medicine_id, ",
            "     0 as mpq, 0, 0, 0, 0, 0, ",
            "     0 as mrq, 0, 0, 0, 0, 0, ",
            "     0 as msq, 0, 0, 0, 0, 0, ",
            "     sum(CASE WHEN date(sim.date_time) <= ${toDate} THEN sid.qty ELSE 0 END) as miq, ",
            "     sum(sid.qty) as diq, ",
            "     sum(CASE WHEN date(sim.date_time) <= ${toDate} THEN cost_value ELSE 0 END) as mic, ",
            "     sum(cost_value) as dic, ",
            "     sum(CASE WHEN date(sim.date_time) <= ${toDate} THEN ",
            "       sid.qty*sibd.mrp/isid.issue_base_unit ELSE 0 END) as mim, ",
            "     sum(sid.qty*sibd.mrp/isid.issue_base_unit) as dim, ",
            "     0 as mtq, 0, 0, 0, 0, 0, ",
            "     0 as maq, 0, 0, 0, 0, 0, ",
            "     0 as mgq, 0, 0, 0, 0, 0, ",
            "    0 as mnq, 0, 0, 0, 0, 0, ",
            "    0 as mjq, 0, 0, 0, 0, 0, ",
            "     0 as c_q, 0, 0 ",
            "   FROM stock_issue_details sid JOIN stock_issue_main sim USING(user_issue_no) ",
            "    JOIN store_item_batch_details sibd ON ( sibd.item_batch_id = sid.item_batch_id)",
            "    JOIN store_item_details isid ON (isid.medicine_id = sid.medicine_id)",
            "   WHERE date(sim.date_time) >= ${fromDate} ",
            "   GROUP BY dept_from, sid.medicine_id ",
            "  ",
            "   UNION ALL ",
            "   -- User issue returns: subtract from user issues ",
            "   SELECT dept_to, sid.medicine_id, ",
            "     0 as mpq, 0, 0, 0, 0, 0, ",
            "     0 as mrq, 0, 0, 0, 0, 0, ",
            "     0 as msq, 0, 0, 0, 0, 0, ",
            "     -sum(CASE WHEN date(sim.date_time) <= ${toDate} THEN sid.qty ELSE 0 END) as miq, ",
            "     -sum(sid.qty) as diq, ",
            "     -sum(CASE WHEN date(sim.date_time) <= ${toDate} THEN cost_value ELSE 0 END) as mic, ",
            "     -sum(cost_value) as dic, ",
            "     -sum(CASE WHEN date(sim.date_time) <= ${toDate} THEN ",
            "       sid.qty*sibd.mrp/isid.issue_base_unit ELSE 0 END) as mim, ",
            "     -sum(sid.qty*sibd.mrp/isid.issue_base_unit) as dim, ",
            "     0 as mtq, 0, 0, 0, 0, 0, ",
            "     0 as maq, 0, 0, 0, 0, 0, ",
            "     0 as mgq, 0, 0, 0, 0, 0, ",
            "    0 as mnq, 0, 0, 0, 0, 0, ",
            "    0 as mjq, 0, 0, 0, 0, 0, ",
            "     0 as c_q, 0, 0 ",
            "   FROM store_issue_returns_details sid ",
            "     JOIN store_issue_returns_main sim using(user_return_no) ",
            "    JOIN store_item_batch_details sibd ON ( sibd.item_batch_id = sid.item_batch_id)",
            "    JOIN store_item_details isid ON (isid.medicine_id = sid.medicine_id)",
            "   WHERE date(sim.date_time) >= ${fromDate} ",
            "   GROUP BY dept_to, sid.medicine_id ",
            "  ",
            "   UNION ALL ",
            "   -- Transfer out for direct stock transfer & indents that are processed but not rejected",
            "   SELECT store_from, st.medicine_id, ",
            "     0 as mpq, 0, 0, 0, 0, 0, ",
            "     0 as mrq, 0, 0, 0, 0, 0, ",
            "     0 as msq, 0, 0, 0, 0, 0, ",
            "     0 as miq, 0, 0, 0, 0, 0, ",
            "     sum(CASE WHEN date(date_time) <= ${toDate} THEN st.qty  ELSE 0 END) as mtq, ",
            "     sum(st.qty) as dtq, ",
            "     sum(CASE WHEN date(date_time) <= ${toDate} THEN st.cost_value ELSE 0 END) as mtc, ",
            "     sum(st.cost_value) as dtc, ",
            "     sum(CASE WHEN date(date_time) <= ${toDate} THEN (st.qty*sibd.mrp/isid.issue_base_unit) ELSE 0 END) as mtm, ",
            "     sum(st.qty*sibd.mrp/isid.issue_base_unit) as dtm, ",
            "     0 as maq, 0, 0, 0, 0, 0, ",
            "     0 as mgq, 0, 0, 0, 0, 0, ",
            "    0 as mnq, 0, 0, 0, 0, 0, ",
            "    0 as mjq, 0, 0, 0, 0, 0, ",
            "     0 as c_q, 0, 0 ",
            "     FROM store_transfer_details st JOIN store_transfer_main sm USING(transfer_no) ",
            "    JOIN store_item_batch_details sibd ON(sibd.item_batch_id = st.item_batch_id) ",
            "    JOIN store_item_details isid ON (isid.medicine_id = st.medicine_id)",
            "   WHERE date(sm.date_time) >= ${fromDate} ",
            "   GROUP BY store_from, st.medicine_id",
            "  ",
            "   UNION ALL ",
            "   -- Transfer out (after receive)",
            "   SELECT store_from, st.medicine_id, ",
            "     0 as mpq, 0, 0, 0, 0, 0, ",
            "     0 as mrq, 0, 0, 0, 0, 0, ",
            "     0 as msq, 0, 0, 0, 0, 0, ",
            "     0 as miq, 0, 0, 0, 0, 0, ",
            "     -sum(CASE WHEN date(reconsolidated_date) <= ${toDate} THEN st.qty_rejected ELSE 0 END) as mtq, ",
            "     -sum(st.qty_rejected) as dtq, ",
            "     -sum(CASE WHEN date(reconsolidated_date) <= ${toDate} THEN (st.cost_value - st.received_cost_value) ELSE 0 END) as mtc, ",
            "     -sum((st.cost_value - st.received_cost_value)) as dtc, ",
            "     -sum(CASE WHEN date(reconsolidated_date) <= ${toDate} THEN st.qty_rejected*sibd.mrp/isid.issue_base_unit ELSE 0 END) as mtm, ",
            "     -sum(st.qty_rejected*sibd.mrp/isid.issue_base_unit) as dtm, ",
            "     0 as maq, 0, 0, 0, 0, 0, ",
            "     0 as mgq, 0, 0, 0, 0, 0, ",
            "    0 as mnq, 0, 0, 0, 0, 0, ",
            "    0 as mjq, 0, 0, 0, 0, 0, ",
            "     0 as c_q, 0, 0 ",
            "   FROM store_transfer_details st ",
            "    JOIN store_transfer_main sm USING(transfer_no) ",
            "    JOIN store_item_batch_details sibd ON(sibd.item_batch_id = st.item_batch_id) ",
            "    JOIN store_item_details isid ON (isid.medicine_id = st.medicine_id)",
            "   WHERE date(st.reconsolidated_date) >= ${fromDate} AND st.indent_no is not null  ",
            "   GROUP BY store_from, st.medicine_id",
            "  ",
            "   UNION ALL ",
            "   -- Transfer in: subtract from transfer out ",
            "   SELECT store_to, st.medicine_id, ",
            "     0 as mpq, 0, 0, 0, 0, 0, ",
            "     0 as mrq, 0, 0, 0, 0, 0, ",
            "     0 as msq, 0, 0, 0, 0, 0, ",
            "     0 as miq, 0, 0, 0, 0, 0, ",
            "     -sum(CASE WHEN date(date_time) <= ${toDate} THEN (st.qty) ELSE 0 END) as mtq, ",
            "     -sum(st.qty) as dtq, ",
            "     -sum(CASE WHEN date(date_time) <= ${toDate} THEN st.cost_value ELSE 0 END) as mtc, ",
            "     -sum(st.cost_value) as dtc, ",
            "     -sum(CASE WHEN date(date_time) <= ${toDate} THEN (st.qty)*sibd.mrp/isid.issue_base_unit ELSE 0 END) as mtm, ",
            "     -sum((st.qty)*sibd.mrp/isid.issue_base_unit) as dtm, ",
            "     0 as maq, 0, 0, 0, 0, 0, ",
            "     0 as mgq, 0, 0, 0, 0, 0, ",
            "    0 as mnq, 0, 0, 0, 0, 0, ",
            "    0 as mjq, 0, 0, 0, 0, 0, ",
            "     0 as c_q, 0, 0 ",
            "   FROM store_transfer_details st JOIN store_transfer_main sm USING(transfer_no) ",
            "    JOIN generic_preferences ON (receive_transfer_indent ='N') ",
            "    JOIN store_item_batch_details sibd ON(sibd.item_batch_id = st.item_batch_id) ",
            "    JOIN store_item_details isid ON (isid.medicine_id = st.medicine_id)",
            "   WHERE date(sm.date_time) >= ${fromDate} AND st.indent_no is not null ",
            "   GROUP BY store_to, st.medicine_id ",
            "  ",
            "   UNION ALL ",
            "   -- Transfer in (after receive)",
            "   SELECT store_to, st.medicine_id, ",
            "     0 as mpq, 0, 0, 0, 0, 0, ",
            "     0 as mrq, 0, 0, 0, 0, 0, ",
            "     0 as msq, 0, 0, 0, 0, 0, ",
            "     0 as miq, 0, 0, 0, 0, 0, ",
            "     -sum(CASE WHEN date(st.received_date) <= ${toDate} THEN st.qty_recd ELSE 0 END) as mtq, ",
            "     -sum(st.qty_recd) as dtq, ",
            "     -sum(CASE WHEN date(st.received_date) <= ${toDate} THEN st.received_cost_value ELSE 0 END) as mtc, ",
            "     -sum(st.received_cost_value) as dtc, ",
            "     -sum(CASE WHEN date(st.received_date) <= ${toDate} THEN st.qty_recd*sibd.mrp/isid.issue_base_unit ELSE 0 END) as mtm, ",
            "     -sum(st.qty_recd*sibd.mrp/isid.issue_base_unit) as dtm, ",
            "     0 as maq, 0, 0, 0, 0, 0, ",
            "     0 as mgq, 0, 0, 0, 0, 0, ",
            "    0 as mnq, 0, 0, 0, 0, 0, ",
            "    0 as mjq, 0, 0, 0, 0, 0, ",
            "     0 as c_q, 0, 0 ",
            "   FROM store_transfer_details st ",
            "    JOIN store_transfer_main sm USING(transfer_no) ",
            "    JOIN generic_preferences ON (receive_transfer_indent ='Y') ",
            "    JOIN store_item_batch_details sibd ON(sibd.item_batch_id = st.item_batch_id) ",
            "    JOIN store_item_details isid ON (isid.medicine_id = st.medicine_id)",
            "   WHERE date(st.received_date) >= ${fromDate} AND st.indent_no is not null  ",
            "   GROUP BY store_to, st.medicine_id",
            "  ",
            "   UNION ALL ",
            "   -- Transfer in for direct stock transfer ",
            "   SELECT store_to, st.medicine_id, ",
            "     0 as mpq, 0, 0, 0, 0, 0, ",
            "     0 as mrq, 0, 0, 0, 0, 0, ",
            "     0 as msq, 0, 0, 0, 0, 0, ",
            "     0 as miq, 0, 0, 0, 0, 0, ",
            "     -sum(CASE WHEN date(date_time) <= ${toDate} THEN st.qty ELSE 0 END) as mtq, ",
            "     -sum(st.qty) as dtq, ",
            "     -sum(CASE WHEN date(date_time) <= ${toDate} THEN st.cost_value ELSE 0 END) as mtc, ",
            "     -sum(st.cost_value) as dtc, ",
            "     -sum(CASE WHEN date(date_time) <= ${toDate} THEN ",
            "      st.qty*sibd.mrp/isid.issue_base_unit ELSE 0 END) as mtm, ",
            "     -sum(st.qty*sibd.mrp/isid.issue_base_unit) as dtm, ",
            "     0 as maq, 0, 0, 0, 0, 0, ",
            "     0 as mgq, 0, 0, 0, 0, 0, ",
            "    0 as mnq, 0, 0, 0, 0, 0, ",
            "    0 as mjq, 0, 0, 0, 0, 0, ",
            "     0 as c_q, 0, 0 ",
            "   FROM store_transfer_details st JOIN store_transfer_main sm USING(transfer_no) ",
            "    JOIN store_item_batch_details sibd ON(sibd.item_batch_id = st.item_batch_id) ",
            "    JOIN store_item_details isid ON (isid.medicine_id = st.medicine_id)",
            "   WHERE date(sm.date_time) >= ${fromDate} AND st.indent_no is null  ",
            "   GROUP BY store_to, st.medicine_id",
            "  ",
            "   UNION ALL ",
            "   -- Stock adj ",
            "   SELECT store_id, a.medicine_id, ",
            "     0 as mpq, 0, 0, 0, 0, 0, ",
            "     0 as mrq, 0, 0, 0, 0, 0, ",
            "     0 as msq, 0, 0, 0, 0, 0, ",
            "     0 as miq, 0, 0, 0, 0, 0, ",
            "     0 as mtq, 0, 0, 0, 0, 0, ",
            "     sum(CASE WHEN date(am.date_time) <= ${toDate} THEN  ",
            "         CASE WHEN a.type LIKE 'A-' OR a.type = 'R' THEN a.qty ELSE -a.qty END ",
            "       ELSE 0 END) as maq, ",
            "     sum(CASE WHEN a.type LIKE 'A-' OR a.type = 'R' THEN a.qty ELSE -a.qty END) as daq, ",
            "     sum(CASE WHEN date(am.date_time) <= ${toDate} THEN ",
            "      CASE WHEN a.type LIKE 'A-' OR a.type = 'R' THEN a.cost_value ELSE -a.cost_value END ",
            "      ELSE 0 END) as mac, ",
            "     sum(CASE WHEN a.type LIKE 'A-' OR a.type = 'R' THEN a.cost_value ELSE -a.cost_value END) as dac, ",
            "     sum(CASE WHEN date(am.date_time) <= ${toDate} THEN  ",
            "         (CASE WHEN a.type LIKE 'A-' OR a.type = 'R' THEN a.qty ELSE -a.qty END) ",
            "         *sibd.mrp/isid.issue_base_unit ELSE 0 END) as mam, ",
            "     sum((CASE WHEN a.type LIKE 'A-' OR a.type = 'R' THEN a.qty ELSE -a.qty END) ",
            "       *sibd.mrp/isid.issue_base_unit) as dam, ",
            "     0 as mgq, 0, 0, 0, 0, 0, ",
            "    0 as mnq, 0, 0, 0, 0, 0, ",
            "    0 as mjq, 0, 0, 0, 0, 0, ",
            "     0 as c_q, 0, 0 ",
            "   FROM store_adj_details a JOIN store_adj_main am USING(adj_no) ",
            "    JOIN store_item_batch_details sibd ON(sibd.item_batch_id = a.item_batch_id) ",
            "    JOIN store_item_details isid ON (isid.medicine_id = a.medicine_id)",
            "   WHERE date(am.date_time) >= ${fromDate} ",
            "   GROUP BY store_id, a.medicine_id ",
            "  ",
            "   UNION ALL ",
            "   -- Reagents / consumables used by tests, services, ot ",
            "   SELECT store_id, sibd.medicine_id, ",
            "     0 as mpq, 0, 0, 0, 0, 0, ",
            "     0 as mrq, 0, 0, 0, 0, 0, ",
            "     0 as msq, 0, 0, 0, 0, 0, ",
            "     0 as miq, 0, 0, 0, 0, 0, ",
            "     0 as mtq, 0, 0, 0, 0, 0, ",
            "     0 as maq, 0, 0, 0, 0, 0, ",
            "     sum(CASE WHEN date(srm.date_time) <= ${toDate} THEN srd.qty ELSE 0 END) as mgq, ",
            "     sum(srd.qty) as dgq, ",
            "     sum(CASE WHEN date(srm.date_time) <= ${toDate} THEN srd.cost_value ELSE 0 END) as mgc, ",
            "     sum(srd.cost_value) as dgc, ",
            "     sum(CASE WHEN date(srm.date_time) <= ${toDate} THEN ",
            "       srd.qty*sibd.mrp/isid.issue_base_unit ELSE 0 END) as mgm, ",
            "     sum(srd.qty*sibd.mrp/isid.issue_base_unit) as dgm, ",
            "    0 as mnq, 0, 0, 0, 0, 0, ",
            "    0 as mjq, 0, 0, 0, 0, 0, ",
            "     0 as c_q, 0, 0 ",
            "   FROM store_reagent_usage_details srd JOIN store_reagent_usage_main srm USING(reagent_usage_seq) ",
            "    JOIN store_item_batch_details sibd ON(sibd.item_batch_id = srd.item_batch_id) ",
            "    JOIN store_item_details isid ON (isid.medicine_id = sibd.medicine_id)",
            "   WHERE date(srm.date_time) >= ${fromDate} ",
            "   GROUP BY store_id, sibd.medicine_id ",
            "  ",
            "   UNION ALL ",
            "   -- Transit Qty",
            "   SELECT store_to, st.medicine_id, ",
            "     0 as mpq, 0, 0, 0, 0, 0, ",
            "     0 as mrq, 0, 0, 0, 0, 0, ",
            "     0 as msq, 0, 0, 0, 0, 0, ",
            "     0 as miq, 0, 0, 0, 0, 0, ",
            "      0 as mtq, 0, 0, 0, 0, 0, ",
            "     0 as maq, 0, 0, 0, 0, 0, ",
            "     0 as mgq, 0, 0, 0, 0, 0, ",
            "     -sum(CASE WHEN date(date_time) <= ${toDate} THEN st.qty  ELSE 0 END) as mnq, ",
            "     -sum(st.qty) as dnq, ",
            "     -sum(CASE WHEN date(date_time) <= ${toDate} THEN st.cost_value ELSE 0 END) as mnc, ",
            "     -sum(st.cost_value) as dnc, ",
            "     -sum(CASE WHEN date(date_time) <= ${toDate} THEN st.qty*sibd.mrp/isid.issue_base_unit ELSE 0 END) as mnm, ",
            "     -sum(st.qty*sibd.mrp/isid.issue_base_unit) as dnm, ",
            "    0 as mjq, 0, 0, 0, 0, 0, ",
            "     0 as c_q, 0, 0 ",
            "     FROM store_transfer_details st JOIN store_transfer_main sm USING(transfer_no) ",
            "    JOIN store_item_batch_details sibd ON(sibd.item_batch_id = st.item_batch_id) ",
            "    JOIN generic_preferences ON(receive_transfer_indent ='Y') ",
            "    JOIN store_item_details isid ON (isid.medicine_id = st.medicine_id)",
            "   WHERE date(sm.date_time) <= ${toDate} AND st.indent_no is not null ",
            "   GROUP BY store_to, st.medicine_id",
            "  ",
            "   UNION ALL ",
            "   -- Transit Qty After receive",
            "   SELECT store_to, st.medicine_id, ",
            "     0 as mpq, 0, 0, 0, 0, 0, ",
            "     0 as mrq, 0, 0, 0, 0, 0, ",
            "     0 as msq, 0, 0, 0, 0, 0, ",
            "     0 as miq, 0, 0, 0, 0, 0, ",
            "     0 as mtq, 0, 0, 0, 0, 0, ",
            "     0 as maq, 0, 0, 0, 0, 0, ",
            "     0 as mgq, 0, 0, 0, 0, 0, ",
            "    sum(CASE WHEN date(st.received_date) <= ${toDate} ",
            "       THEN st.qty_recd+st.qty_rejected ELSE 0 END) as mnq, ",
            "    sum(st.qty_recd+st.qty_rejected) as dnq, ",
            "     sum(CASE WHEN date(st.received_date) <=${toDate} ",
            "      THEN ",
            "        (CASE WHEN st.qty_recd+st.qty_rejected >0 THEN st.cost_value ELSE 0 END) ",
            "      ELSE 0 END) as mnc, ",
            "    sum(CASE WHEN st.qty_recd+st.qty_rejected >0 THEN st.cost_value ELSE 0 END) as dnc, ",
            "    sum(CASE WHEN date(st.received_date) <=${toDate} ",
            "      THEN (st.qty_recd+st.qty_rejected)*sibd.mrp/isid.issue_base_unit ELSE 0 END) as mnm, ",
            "     sum((st.qty_recd+st.qty_rejected)*sibd.mrp/isid.issue_base_unit )as dnm ,",
            "    0 as mjq, 0, 0, 0, 0, 0, ",
            "     0 as c_q, 0, 0 ",
            "  FROM store_transfer_details st ",
            "  JOIN store_transfer_main sm USING(transfer_no) ",
            "  JOIN store_item_batch_details sibd ON(sibd.item_batch_id = st.item_batch_id) ",
            "  JOIN store_item_details isid ON (isid.medicine_id = st.medicine_id) ",
            "  JOIN generic_preferences ON(receive_transfer_indent ='Y') ",
            "  WHERE date(st.received_date) <= ${toDate}  AND st.indent_no is not null ",
            "   GROUP BY store_to, st.medicine_id ",
            "  ",
            "   UNION ALL ",
            "   -- Rejected Qty",
            "   SELECT store_from, st.medicine_id, ",
            "     0 as mpq, 0, 0, 0, 0, 0, ",
            "     0 as mrq, 0, 0, 0, 0, 0, ",
            "     0 as msq, 0, 0, 0, 0, 0, ",
            "     0 as miq, 0, 0, 0, 0, 0, ",
            "      0 as mtq, 0, 0, 0, 0, 0, ",
            "     0 as maq, 0, 0, 0, 0, 0, ",
            "     0 as mgq, 0, 0, 0, 0, 0, ",
            "    0 as mnq, 0, 0, 0, 0, 0, ",
            "     -sum(CASE WHEN date(st.received_date) <= ${toDate} THEN st.qty_rejected  ELSE 0 END) as mjq, ",
            "     -sum(st.qty_rejected) as djq, ",
            "     -sum(CASE WHEN date(st.received_date) <= ${toDate} THEN coalesce((st.cost_value - st.received_cost_value), 0) ELSE 0 END) as mjc, ",
            "     -sum(coalesce((st.cost_value - st.received_cost_value), 0)) as djc, ",
            "     -sum(CASE WHEN date(st.received_date) <= ${toDate} THEN st.qty_rejected*sibd.mrp/isid.issue_base_unit ELSE 0 END) as mjm, ",
            "     -sum(st.qty_rejected*sibd.mrp/isid.issue_base_unit) as djm, ",
            "     0 as c_q, 0, 0 ",
            "   FROM store_transfer_details st ",
            "    JOIN store_transfer_main sm USING(transfer_no) ",
            "    JOIN store_item_batch_details sibd ON(sibd.item_batch_id = st.item_batch_id) ",
            "    JOIN store_item_details isid ON (isid.medicine_id = st.medicine_id)",
            "   WHERE date(st.received_date) <= ${toDate} AND st.indent_no is not null  ",
            "   GROUP BY store_from, st.medicine_id",
            "  ",
            "   UNION ALL ",
            "   -- Rejected Qty After taken back to stock",
            "   SELECT store_from, st.medicine_id, ",
            "     0 as mpq, 0, 0, 0, 0, 0, ",
            "     0 as mrq, 0, 0, 0, 0, 0, ",
            "     0 as msq, 0, 0, 0, 0, 0, ",
            "     0 as miq, 0, 0, 0, 0, 0, ",
            "      0 as mtq, 0, 0, 0, 0, 0, ",
            "     0 as maq, 0, 0, 0, 0, 0, ",
            "     0 as mgq, 0, 0, 0, 0, 0, ",
            "    0 as mnq, 0, 0, 0, 0, 0, ",
            "     sum(CASE WHEN date(st.reconsolidated_date) <= ${toDate} THEN st.qty_rejected  ELSE 0 END) as mjq, ",
            "     sum(st.qty_rejected) as djq, ",
            "     sum(CASE WHEN date(st.reconsolidated_date) <= ${toDate} THEN coalesce((st.cost_value - st.received_cost_value), 0) ELSE 0 END) as mjc, ",
            "     sum(coalesce((st.cost_value - st.received_cost_value), 0)) as djc, ",
            "     sum(CASE WHEN date(st.reconsolidated_date) <= ${toDate} THEN st.qty_rejected*sibd.mrp/isid.issue_base_unit ELSE 0 END) as mjm, ",
            "     sum(st.qty_rejected*sibd.mrp/isid.issue_base_unit) as djm, ",
            "     0 as c_q, 0, 0 ",
            "   FROM store_transfer_details st ",
            "    JOIN store_transfer_main sm USING(transfer_no) ",
            "    JOIN store_item_batch_details sibd ON(sibd.item_batch_id = st.item_batch_id) ",
            "    JOIN store_item_details isid ON (isid.medicine_id = st.medicine_id)",
            "   WHERE date(st.reconsolidated_date) <= ${toDate} AND st.indent_no is not null  ",
            "   GROUP BY store_from, st.medicine_id",
            "  ",
            "   UNION ALL ",
            "   -- Current stock quantity ",
            "   SELECT dept_id, ssd.medicine_id, ",
            "     0 as mpq, 0, 0, 0, 0, 0, ",
            "     0 as mrq, 0, 0, 0, 0, 0, ",
            "     0 as msq, 0, 0, 0, 0, 0, ",
            "     0 as miq, 0, 0, 0, 0, 0, ",
            "     0 as mtq, 0, 0, 0, 0, 0, ",
            "     0 as maq, 0, 0, 0, 0, 0, ",
            "     0 as mgq, 0, 0, 0, 0, 0, ",
            "    0 as mnq, 0, 0, 0, 0, 0, ",
            "    0 as mjq, 0, 0, 0, 0, 0, ",
            "     sum(qty) as c_q, ",
            "     sum(qty*sild.package_cp/isid.issue_base_unit) as c_c, ",
            "     sum(qty*sibd.mrp/isid.issue_base_unit) as c_m ",
            "   FROM store_stock_details ssd ",
            "  JOIN store_item_batch_details sibd USING(item_batch_id)",
            "  JOIN store_item_lot_details sild ON(ssd.item_lot_id = sild.item_lot_id)",
            "  JOIN store_item_details isid ON (ssd.medicine_id = isid.medicine_id)",
            "   GROUP BY dept_id, ssd.medicine_id ",
            "  ",
            " ) AS smview ",
            "   JOIN store_item_details sid USING (medicine_id) ",
            "   JOIN stores s on (s.dept_id=smview.store_id) ",
            "   JOIN hospital_center_master hcm ON(s.center_id = hcm.center_id) ",
            "   LEFT JOIN generic_name gn ON(gn.generic_code = sid.generic_name) ",
            "   LEFT JOIN store_category_master scm ON(scm.category_id=sid.med_category_id) ",
            "  LEFT JOIN store_type_master stm on(stm.store_type_id = s.store_type_id) ",
            "   LEFT JOIN service_sub_groups ssg on(ssg.service_sub_group_id = sid.service_sub_group_id) ",
            "  LEFT JOIN service_groups sg on(sg.service_group_id = ssg.service_group_id) ",
            "   LEFT JOIN item_form_master ifm ON ifm.item_form_id=sid.item_form_id ",
            " GROUP BY dept_name, medicine_name,cust_item_code, center_name, scm.category, gn.generic_name, store_type_name, service_sub_group_name, service_group_name,ifm.item_form_name ,sid.issue_units,sid.package_uom"
        ]
    ],
    "filterOnlyFields": {
        "txn_date": {
            "displayName": "Transaction Date",
            "dataType": "date"
        }
    },
    "fields": {
        "dept_name": {
            "table": "s",
            "displayName": "Store Name",
            "width": 100,
            "filterable": true,
            "groupable": true,
            "allowedValuesQuery": "SELECT dept_name FROM stores ORDER BY dept_name"
        },
        "center_name": {
            "table": "hcm",
            "displayName": "Center Name",
            "width": 100,
            "filterable": true,
            "groupable": true,
            "allowedValuesQuery": "SELECT center_name FROM hospital_center_master WHERE center_id!=0 order by center_name"
        },
        "medicine_name": {
            "table": "sid",
            "displayName": "Item Name",
            "width": 140,
            "filterable": true
        },
        "cust_item_code": {
            "table": "sid",
            "displayName": "Custom Item Code",
            "width": 140,
            "filterable": true
        },
        "category": {
            "table": "scm",
            "displayName": "Item Category",
            "width": 100,
            "filterable": true,
            "groupable": true,
            "allowedValuesQuery": "SELECT category FROM store_category_master order by category"
        },
        "generic_name": {
            "table": "gn",
            "displayName": "Generic Name",
            "width": 100,
            "groupable": true
        },
        "store_type_name": {
            "table": "stm",
            "displayName": "Store Type",
            "width": 100,
            "groupable": true,
            "filterable": true,
            "allowedValuesQuery": "select store_type_name from store_type_master order by store_type_name"
        },
        "service_sub_group_name": {
            "table": "ssg",
            "displayName": "Service sub group",
            "width": 100,
            "groupable": true,
            "filterable": true,
            "allowedValuesQuery": "select service_sub_group_name from service_sub_groups order by service_sub_group_name"
        },
        "service_group_name": {
            "table": "sg",
            "displayName": "Service group",
            "width": 100,
            "groupable": true,
            "filterable": true,
            "allowedValuesQuery": "select service_group_name from service_groups order by service_group_name"
        },
        "item_form_name": {
            "table": "ifm",
            "displayName": "Item Form Name",
            "width": 100,
            "groupable": true,
            "filterable": true,
            "allowedValuesQuery": "select item_form_name from item_form_master order by item_form_name"
        },
        "o_q": {
            "displayName": "Opening Qty",
            "dataType": "numeric",
            "decimalType": "quantity",
            "aggFunction": "sum",
            "expression": "0"
        },
        "mpq": {
            "displayName": "Purchases Qty",
            "dataType": "numeric",
            "decimalType": "quantity",
            "aggFunction": "sum",
            "expression": "0"
        },
        "mrq": {
            "displayName": "Supplier Returns Qty",
            "dataType": "numeric",
            "decimalType": "quantity",
            "aggFunction": "sum",
            "expression": "0"
        },
        "mtq": {
            "displayName": "Transfers Qty",
            "dataType": "numeric",
            "decimalType": "quantity",
            "aggFunction": "sum",
            "expression": "0"
        },
        "msq": {
            "displayName": "Sales Qty",
            "dataType": "numeric",
            "decimalType": "quantity",
            "aggFunction": "sum",
            "expression": "0"
        },
        "miq": {
            "displayName": "Issues Qty",
            "dataType": "numeric",
            "decimalType": "quantity",
            "aggFunction": "sum",
            "expression": "0"
        },
        "mgq": {
            "displayName": "Reagents Qty",
            "dataType": "numeric",
            "decimalType": "quantity",
            "aggFunction": "sum",
            "expression": "0"
        },
        "mnq": {
            "displayName": "Transit Qty",
            "dataType": "numeric",
            "decimalType": "quantity",
            "aggFunction": "sum",
            "experession": "0"
        },
        "mjq": {
            "displayName": "Rejected Qty",
            "dataType": "numeric",
            "decimalType": "quantity",
            "aggFunction": "sum",
            "experession": "0"
        },
        "maq": {
            "displayName": "Adj. Qty",
            "description": "Total quantity decremented in the period",
            "dataType": "numeric",
            "decimalType": "quantity",
            "aggFunction": "sum",
            "expression": "0"
        },
        "m_q": {
            "displayName": "Net Qty",
            "description": "Total quantity added in the period",
            "dataType": "numeric",
            "decimalType": "quantity",
            "aggFunction": "sum",
            "expression": "0",
            "filterable": true
        },
        "f_q": {
            "displayName": "Closing Qty",
            "dataType": "numeric",
            "decimalType": "quantity",
            "aggFunction": "sum",
            "expression": "0",
            "filterable": true
        },
        "o_c": {
            "displayName": "Opening Cost",
            "width": 80,
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0"
        },
        "mpc": {
            "displayName": "Purchases Cost",
            "width": 80,
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0"
        },
        "mrc": {
            "displayName": "Supplier Returns Cost",
            "width": 80,
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0"
        },
        "mtc": {
            "displayName": "Transfers Cost",
            "width": 80,
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0"
        },
        "msc": {
            "displayName": "Sales Cost",
            "width": 80,
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0"
        },
        "mic": {
            "displayName": "Issues Cost",
            "width": 80,
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0"
        },
        "mgc": {
            "displayName": "Reagents Cost",
            "width": 80,
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0"
        },
        "mnc": {
            "displayName": "Transit Cost",
            "width": 80,
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0"
        },
        "mjc": {
            "displayName": "Rejected Cost",
            "width": 80,
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0"
        },
        "mac": {
            "displayName": "Adj. Cost",
            "width": 80,
            "description": "Total Cost value decremented in the period",
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0"
        },
        "m_c": {
            "displayName": "Net Cost",
            "width": 80,
            "description": "Total cost value added in the period",
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0",
            "filterable": true
        },
        "f_c": {
            "displayName": "Closing Cost",
            "width": 80,
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0"
        },
        "o_m": {
            "displayName": "Opening MRP",
            "width": 80,
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0"
        },
        "mpm": {
            "displayName": "Purchases MRP",
            "width": 80,
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0"
        },
        "mrm": {
            "displayName": "Supplier Returns MRP",
            "width": 80,
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0"
        },
        "mtm": {
            "displayName": "Transfers MRP",
            "width": 80,
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0"
        },
        "msm": {
            "displayName": "Sales MRP",
            "width": 80,
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0"
        },
        "mim": {
            "displayName": "Issues MRP",
            "width": 80,
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0"
        },
        "mgm": {
            "displayName": "Reagents MRP",
            "width": 80,
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0"
        },
        "mnm": {
            "displayName": "Transit MRP",
            "width": 80,
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0"
        },
        "mjm": {
            "displayName": "Rejected MRP",
            "width": 80,
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0"
        },
        "mam": {
            "displayName": "Adj. MRP",
            "width": 80,
            "description": "Total MRP value decremented in the period",
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0"
        },
        "m_m": {
            "displayName": "Net MRP",
            "width": 80,
            "description": "Total MRP value added in the period",
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0",
            "filterable": true
        },
        "f_m": {
            "displayName": "Closing MRP",
            "width": 80,
            "dataType": "numeric",
            "decimalType": "amount",
            "aggFunction": "sum",
            "expression": "0"
        },
        "issue_uom": {
            "displayName": "Unit UOM",
            "width": 60,
            "filterable": true,
            "groupable": true
        },
        "package_uom": {
            "table": "sid",
            "displayName": "Package UOM",
            "width": 60,
            "filterable": true,
            "groupable": true
        }
    },
    "defaultShowFields": [
        "dept_name",
        "medicine_name",
        "o_q",
        "mpq",
        "mrq",
        "msq",
        "miq",
        "mtq",
        "mnq",
        "mjq",
        "maq",
        "mgq",
        "m_q",
        "f_q"
    ]
}