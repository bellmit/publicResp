{
    "title": "Bills Report",
    "reportGroup": "Billing Reports",
    "description": "This report shows all Bills within the given date range, the value of the bill and various attributes of the bill.",
    "dateFields": [
        "open_date",
        "finalized_date",
        "closed_date",
        "visit_date",
        "payment_recd_date"
    ],
    "allowNoDate": true,
    "defaultOrder": "bill_no",
    "defaultShowFields": [
        "bill_no",
        "bill_patient_full_name",
        "bill_status",
        "total_amount",
        "total_receipts"
    ],
    "includes": [
        "BillDetailFields.srjs",
        "PatientVisitFields.srjs",
        "PatientDetailFields.srjs"
    ],
    "fields": {
        "bill_patient_full_name": {
            "displayName": "Patient Name",
            "width": "150",
            "description": "Patient or Retail Customer Name",
            "expressionLines": [
                "COALESCE ((smb.salutation || ' ' || pd.patient_name ",
                " || CASE WHEN coalesce(pd.middle_name, '') = '' THEN '' ELSE (' ' || pd.middle_name) END ",
                " || CASE WHEN coalesce(pd.last_name, '')   = '' THEN '' ELSE (' ' || pd.last_name) END), ",
                " prc.customer_name, isr.patient_name) "
            ],
            "table": "smb,pr,prc,isr",
            "groupable": true
        },
        "visit_date": {
            "displayName": "Visit Date",
            "dataType": "date",
            "width": "60",
            "groupable": true,
            "expression": "pr.reg_date",
            "table": "pr"
        },
        "primary_sponsor_type": {
            "displayName": "Primary Sponsor Type ",
            "width": "100",
            "dataType": "string",
            "expression": "(pst.sponsor_type_name)",
            "table": "pst",
            "groupable": true,
            "filterable": true
        },
        "secondary_sponsor_type": {
            "displayName": "Secondary Sponsor Type ",
            "width": "100",
            "dataType": "string",
            "expression": "(sst.sponsor_type_name)",
            "table": "sst",
            "groupable": true,
            "filterable": true
        },
        "admit_date": {
            "displayName": "Admission Date",
            "dataType": "date",
            "width": "60",
            "groupable": true,
            "expression": "pr.reg_date",
            "table": "pr"
        },
        "payment_reference": {
            "displayName": "Payment Reference",
            "width": "90",
            "groupable": true,
            "filterable": true,
            "table": "rv"
        },
        "bill_amount": {
            "displayName": "Gross Amt",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "expression": "(b.total_amount + b.total_discount + b.total_tax)",
            "filterable": true
        },
        "pri_claim_id": {
            "displayName": "Pri. Claim Id ",
            "width": "100",
            "dataType": "string",
            "expression": "(bcclmid.pri_claim_id)",
            "table": "b,bcclmid",
            "groupable": true,
            "filterable": true
        },
        "sec_claim_id": {
            "displayName": "Sec. Claim Id ",
            "width": "100",
            "dataType": "string",
            "expression": "(secbcclmid.sec_claim_id)",
            "table": "b,secbcclmid",
            "groupable": true,
            "filterable": true
        },
        "total_discount": {
            "displayName": "Discount Amt",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "filterable": true
        },
        "total_amount": {
            "displayName": "Net Amt w/o Taxes",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "expression": "(b.total_amount )",
            "aggFunction": "sum",
            "filterable": true
        },
        "total_amount_with_tax": {
            "displayName": "Net Amt w/ Taxes",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "expression": "(b.total_amount + b.total_tax)",
            "aggFunction": "sum",
            "filterable": true
        },
        "total_receipts": {
            "displayName": "Patient Paid Amt",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "filterable": true
        },
        "total_claim": {
            "displayName": "Total Sponsor Amt",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "filterable": true,
            "expression": "(b.total_claim + b.total_claim_tax -  b.insurance_deduction)",
            "table": "b"
        },
        "dyna_package_charge": {
            "displayName": "Dyna Package Charge",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "70",
            "aggFunction": "sum",
            "filterable": true
        },
        "insurance_deduction": {
            "displayName": "Patient Deduction",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "filterable": true
        },
        "claim_recd_amount": {
            "displayName": "Total Sponsor Paid Amt",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "filterable": true,
            "expression": "CASE WHEN (COALESCE(b.primary_total_sponsor_receipts,0) + COALESCE(b.secondary_total_sponsor_receipts,0)) = 0 THEN COALESCE(b.claim_recd_amount,0) ELSE (COALESCE(b.primary_total_sponsor_receipts,0)+COALESCE(b.secondary_total_sponsor_receipts,0)) END "
        },
        "claim_recd_unalloc_amount": {
            "displayName": "Unallocated Sponsor Amt",
            "description": "Unallocated Aponsor Amt",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "filterable": true
        },
        "deposit_set_off": {
            "displayName": "Deposit Set Off",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "filterable": true
        },
        "points_earned": {
            "displayName": "Points Earned",
            "dataType": "numeric",
            "decimalType": "integer",
            "width": "100",
            "aggFunction": "sum",
            "filterable": true
        },
        "points_redeemed": {
            "displayName": "Points Redeemed",
            "dataType": "numeric",
            "decimalType": "integer",
            "width": "100",
            "aggFunction": "sum",
            "filterable": true,
            "table": "b",
            "expression": "b.points_redeemed"
        },
        "points_redeemed_amt": {
            "displayName": "Points Redeemed Amt",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "filterable": true
        },
        "due_amount": {
            "displayName": "Patient Due Amt",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "expression": "(b.total_amount + b.total_tax - b.total_receipts - b.total_claim - b.total_claim_tax  - b.deposit_set_off - b.points_redeemed_amt  )",
            "filterable": true
        },
        "patient_amount": {
            "displayName": "Patient Amt",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "expression": "(b.total_amount + b.total_tax - b.total_claim - b.total_claim_tax)",
            "filterable": true
        },
        "write_off": {
            "displayName": "Patient Write-Off Amt.",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "expression": "(CASE WHEN b.status = 'C' THEN GREATEST((b.total_amount + b.total_tax + b.insurance_deduction - b.total_receipts - b.total_claim - b.total_claim_tax - b.deposit_set_off-b.points_redeemed_amt), 0) ELSE 0::NUMERIC END)",
            "filterable": true
        },
        "primary_tpa_due": {
            "displayName": "Pri. Sponsor Due Amt",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "filterable": true,
            "table": "btcdv,c",
            "expression": "COALESCE(btcdv.pri_claim_amt,0) + COALESCE(btcdv.pri_claim_amt_tax,0) - (COALESCE(btcdv.pri_claim_recd_total,0))"
        },
        "secondary_tpa_due": {
            "displayName": "Sec. Sponsor Due Amt",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "filterable": true,
            "table": "btcdv,c",
            "expression": "COALESCE(btcdv.sec_claim_amt,0) + COALESCE(btcdv.sec_claim_amt_tax,0) - (COALESCE(btcdv.sec_claim_recd_total,0))"
        },
        "primary_tpa_writeoff": {
            "displayName": "Pri. Sponsor Write-Off Amt",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "filterable": true,
            "table": "btcdv",
            "expression": "CASE WHEN b.sponsor_writeoff='A' THEN (COALESCE(btcdv.pri_claim_amt,0) + COALESCE(btcdv.pri_claim_amt_tax,0) - (COALESCE(btcdv.pri_claim_recd_total,0))) ELSE 0 END"
        },
        "secondary_tpa_writeoff": {
            "displayName": "Sec. Sponsor Write-Off Amt",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "filterable": true,
            "table": "btcdv",
            "expression": "CASE WHEN b.sponsor_writeoff = 'A' THEN (COALESCE(btcdv.sec_claim_amt,0) + COALESCE(btcdv.sec_claim_amt_tax,0) -(COALESCE(btcdv.sec_claim_recd_total,0))) ELSE 0 END"
        },
        "o_datetime": {
            "displayName": "Open Date Time",
            "dataType": "timestamp",
            "width": "100",
            "filterable": true,
            "expression": "(b.open_date)"
        },
        "bill_excess": {
            "displayName": "Excess Bill over Approval Amt",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "expression": "(b.total_amount-b.approval_amount)",
            "filterable": true
        },
        "claim_excess": {
            "displayName": "Excess Claim over Approval Amt",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "expression": "(b.total_claim-b.approval_amount)",
            "filterable": true
        },
        "approval_type": {
            "displayName": "Approval Type",
            "width": "100",
            "groupable": true,
            "filterable": true,
            "expression": "CASE WHEN b.approval_amount = 0 THEN 'Unlimited' WHEN b.approval_amount is null THEN 'NA' WHEN b.approval_amount > 0 THEN 'Limited' END",
            "allowedValues": [
                "Limited",
                "Unlimited",
                "NA"
            ]
        },
        "pri_total_claim": {
            "displayName": "Pri. Sponsor Amt",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "filterable": true,
            "table": "btcdv",
            "expression": "COALESCE(btcdv.pri_claim_amt,0) + COALESCE(btcdv.pri_claim_amt_tax,0)"
        },
        "sec_total_claim": {
            "displayName": "Sec. Sponsor Amt",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "filterable": true,
            "table": "btcdv",
            "expression": "COALESCE(btcdv.sec_claim_amt,0) + COALESCE(btcdv.sec_claim_amt_tax,0)"
        },
        "full_name": {},
        "cancel_reason": {
            "displayName": "Cancel Reason"
        },
        "reopen_reason": {
            "displayName": "Reopen Reason"
        },
        "selfpay_batch_id": {
            "displayName": "Selfpay Batch ID"
        },
        "finalized_time": {
            "dataType": "timestamp",
            "displayName": "Finalized Date/Time",
            "expression": " b.finalized_date ",
            "filterable": true,
            "groupable": true,
            "table": "b",
            "width": 100
        },
        "bill_label_name": {
            "displayName": "Bill Label Name",
            "table": "blm",
            "allowedValuesQuery": "SELECT blm.bill_label_name FROM bill_label_master AS blm WHERE blm.status ='A' ORDER BY blm.bill_label_name",
            "filterable": true,
            "groupable": true
        },
        "ip_deposit_set_off": {
            "displayName": "IP Deposit set-off",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "filterable": true
        },
        "pri_insurance_claim_status": {
            "table": "pic",
            "displayName": "Pri. Insurance Claim Status",
            "width": "60",
            "groupable": true,
            "filterable": true,
            "allowNull": true,
            "allowedValues": [
                "Open",
                "Sent",
                "Denied",
                "ForResubmission",
                "Closed"
            ],
            "expressionLines": [
                " CASE WHEN pic.status='O' THEN 'Open' ",
                " WHEN pic.status='S' THEN 'Sent' ",
                " WHEN pic.status='B' THEN 'Batched' ",
                " WHEN pic.status='M' THEN 'ForResubmission' ",
                " WHEN pic.status='C' THEN 'Closed' ",
                " ELSE null END "
            ]
        },
        "sec_insurance_claim_status": {
            "table": "sic",
            "displayName": "Sec. Insurance Claim Status",
            "width": "60",
            "groupable": true,
            "filterable": true,
            "allowNull": true,
            "allowedValues": [
                "Open",
                "Sent",
                "Denied",
                "ForResubmission",
                "Closed"
            ],
            "expressionLines": [
                " CASE WHEN sic.status='O' THEN 'Open' ",
                " WHEN sic.status='S' THEN 'Sent' ",
                " WHEN sic.status='B' THEN 'Batched' ",
                " WHEN sic.status='M' THEN 'ForResubmission' ",
                " WHEN sic.status='C' THEN 'Closed' ",
                " ELSE null END "
            ]
        },
        "bill_amount_tax": {
            "displayName": "Bill Amt",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "expression": "(b.total_amount + b.total_tax )",
            "filterable": true
        },
        "total_sponsor_due_amount": {
            "displayName": "Total Sponsor Due Amt",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "expression": " CASE WHEN (COALESCE(b.primary_total_sponsor_receipts,0) + COALESCE(b.secondary_total_sponsor_receipts,0)) = 0 THEN (b.total_claim + b.total_claim_tax - COALESCE(b.claim_recd_amount,0)) ELSE (b.total_claim + b.total_claim_tax - COALESCE(b.primary_total_sponsor_receipts,0) - COALESCE(b.secondary_total_sponsor_receipts,0)) END ",
            "filterable": true
        },
        "total_due_amount": {
            "displayName": "Total Due Amt",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "expression": "CASE WHEN (COALESCE(b.primary_total_sponsor_receipts,0) + COALESCE(b.secondary_total_sponsor_receipts,0)) = 0 THEN (b.total_amount + b.total_tax - b.total_receipts - b.deposit_set_off - b.points_redeemed_amt - COALESCE(b.claim_recd_amount,0) ) ELSE (b.total_amount + b.total_tax - b.total_receipts - b.deposit_set_off - b.points_redeemed_amt - COALESCE(b.primary_total_sponsor_receipts,0) - COALESCE(b.secondary_total_sponsor_receipts,0) ) END ",
            "filterable": true
        },
        "pri_sponsor_paid_amt": {
            "displayName": "Pri. Sponsor Paid Amt",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "table": "b,btcdv",
            "expression": "(COALESCE(btcdv.pri_claim_recd_total,0))",
            "filterable": true
        },
        "sec_sponsor_paid_amt": {
            "displayName": "Sec. Sponsor Paid Amt",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "table": "b,btcdv",
            "expression": "(COALESCE(btcdv.sec_claim_recd_total,0) )",
            "filterable": true
        },
        "pri_sponsor_amt_wo_taxes": {
            "displayName": "Pri. Sponsor Amt w/o Taxes",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "table": "btcdv",
            "expression": "COALESCE(btcdv.pri_claim_amt,0)",
            "filterable": true
        },
        "sec_sponsor_amt_wo_taxes": {
            "displayName": "Sec. Sponsor Amt w/o Taxes",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "table": "btcdv",
            "expression": "COALESCE(btcdv.sec_claim_amt,0)",
            "filterable": true
        },
        "patient_amt_wo_taxes": {
            "displayName": "Patient Amt w/o Taxes",
            "dataType": "numeric",
            "decimalType": "amount",
            "width": "100",
            "aggFunction": "sum",
            "expression": "(b.total_amount - b.total_claim)",
            "filterable": true
        },
        "username": {
            "allowHorizGroup": true,
            "allowNull": true,
            "allowedValuesQuery": "SELECT emp_username AS username FROM u_user JOIN u_role USING(role_id)\n    WHERE  portal_id='N'  ORDER BY username",
            "dataType": "string",
            "displayName": "Last Modified By",
            "expression": "b.username",
            "filterable": true,
            "groupable": true,
            "name": "username",
            "table": "b",
            "width": 70
        }
    },
    "queryUnits": [
        {
            "mainTableAlias": "b",
            "mainTableName": "bill",
            "joinTables": [
                {
                    "name": "(SELECT ar.bill_no, ar.payment_reference, ar.reference_no FROM (SELECT distinct(bill_no), payment_reference,ir.reference_no FROM insurance_remittance ir JOIN insurance_payment_allocation USING (remittance_id) JOIN bill_charge USING(charge_id) UNION ALL SELECT bill_no, payment_reference,ir.reference_no FROM insurance_remittance ir JOIN insurance_remittance_details USING (remittance_id) JOIN bill_claim USING(claim_id)) as ar GROUP BY ar.bill_no, ar.payment_reference,ar.reference_no)",
                    "alias": "rv",
                    "expression": "ON (b.bill_no = rv.bill_no)",
                    "dependsOn": "b",
                    "type": "LEFTLATERAL"
                },
                {
                    "name": "(SELECT pri_claim.claim_recd_total as pri_claim_recd_total,sec_claim.claim_recd_total as sec_claim_recd_total,pri_claim.total_claim as pri_claim_amt, pri_claim.total_claim_tax as pri_claim_amt_tax, sec_claim.total_claim as sec_claim_amt,sec_claim.total_claim_tax as sec_claim_amt_tax,pri_claim.bill_no FROM  (SELECT sum(claim_recd_total) as claim_recd_total,sum(bcc.insurance_claim_amt) as total_claim,sum(bcc.tax_amt) as total_claim_tax, bc.bill_no FROM bill_charge_claim bcc JOIN bill_claim bc ON(bc.claim_id=bcc.claim_id AND bc.bill_no=bcc.bill_no) WHERE bc.priority = 1 and bc.bill_no = b.bill_no GROUP BY bc.bill_no) pri_claim  LEFT JOIN (SELECT sum(claim_recd_total) as claim_recd_total,sum(bcc.insurance_claim_amt) as total_claim, sum(bcc.tax_amt) as total_claim_tax,  bc.bill_no FROM bill_charge_claim bcc JOIN bill_claim bc ON(bc.claim_id=bcc.claim_id AND bc.bill_no=bcc.bill_no) WHERE bc.priority = 2  GROUP BY bc.bill_no) sec_claim ON(sec_claim.bill_no = b.bill_no) )",
                    "alias": "btcdv",
                    "expression": "ON (b.bill_no = btcdv.bill_no)",
                    "dependsOn": "b",
                    "type": "LEFTLATERAL"
                },
                {
                    "alias": "bcclmid",
                    "dependsOn": "b",
                    "expression": "ON (b.bill_no = bcclmid.bill_no)",
                    "name": "(SELECT bcl.bill_no,bcl.claim_id as pri_claim_id FROM bill_claim bcl where bcl.priority = 1 and bcl.bill_no = b.bill_no  GROUP BY bill_no,bcl.claim_id)",
                    "type": "LEFTLATERAL"
                },
                {
                    "alias": "secbcclmid",
                    "dependsOn": "b",
                    "expression": "ON (b.bill_no = secbcclmid.bill_no)",
                    "name": "(SELECT bcl.bill_no,bcl.claim_id as sec_claim_id FROM bill_claim bcl where bcl.priority = 2 and bcl.bill_no = b.bill_no GROUP BY bill_no,bcl.claim_id)",
                    "type": "LEFTLATERAL"
                },
                {
                    "alias": "pic",
                    "dependsOn": "bcclmid",
                    "expression": "ON(pic.claim_id = bcclmid.pri_claim_id)",
                    "name": "insurance_claim",
                    "type": "LEFT"
                },
                {
                    "alias": "sic",
                    "dependsOn": "secbcclmid",
                    "expression": "ON(sic.claim_id = secbcclmid.sec_claim_id)",
                    "name": "insurance_claim",
                    "type": "LEFT"
                },
                {
                    "name": "bill_label_master",
                    "alias": "blm",
                    "dependsOn": "b",
                    "expression": "ON (b.bill_label_id = blm.bill_label_id)",
                    "type": "LEFT"
                }
            ]
        }
    ]
}