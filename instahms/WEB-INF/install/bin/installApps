#!/bin/bash
#
# Install script: this is called from within the build directory, for the
# first time installation of the software. Tomcat may or may not be running
# another application (eg, installing hmsNew, whereas hms is already running)
# when this is called.
#
# This should be called like this:
#  bash /root/Appsbuilds/3.0.0-1111/WEB-INF/install/bin/install <app>
# where app is like 'apps'.
# (bash is required since the distribution does not preserve permissions)
#
# The software will be installed in /root/webapps/<app> . This install does not create a database

source `dirname $0`/functions

#
# Initial checks
#

# functions think that we are running from approot. Need to reset
# it and set APPROOT, APP and DB appropriately.
DISTDIR=$APPROOT

# check usage
APP=$1
[ -z $APP ] && echo "Usage: installApps <app> <hmsdb>" && exit 1

HMSDB=$2
[ -z $HMSDB ] && echo "Usage: installApps <app> <hmsdb>" && exit 1

sudo mkdir -p /var/log/insta/$APP

# check not already occupied app
DB=$APP
APPROOT=$APPHOME/insta${APP}
[ -e $APPROOT ] && echo "Application already installed at $APPROOT" && exit 1

# check tomcat is installed
[ ! -d $TOMCAT_HOME ] && echo "Tomcat not installed: please install at $TOMCAT_HOME" && exit 1

if [ "$ENABLE_SSL" == "Y" ] ; then
	sudo sed --in-place -e '/REMOVE_FOR_SSL/d' $TOMCAT_HOME/conf/server.xml
fi


# check java installed
[ ! -d /usr/lib/jvm/jdk1.7.0_80 ] && echo "Java 7 not installed: please install at /usr/lib/jvm/jdk1.7.0_80" \
	&& exit 1


#
# Stop the application, if it is already installed and running
#
if [ -f /etc/init.d/tomcat-9 ] ; then
	sudo /etc/init.d/tomcat-9 stop
fi
#
# Software: copy the distribution on to the approot
#
echo "Creating app root at: $APPROOT"
sudo cp -a $DISTDIR $APPROOT

BINPATH=$APPROOT/WEB-INF/install/bin
# dist does not have permissions, whereas installed dir must have.
sudo chmod -R +x $BINPATH/*

#
# run our postinstall script
# This is a hook for modifying the war contents and/or copying any files to
# the os filesystem directories outside our app root.
echo "Running postinstall"
if [ -x $BINPATH/postinstall ] ; then
# $APP is not used in postinstall but postinstall needs the two parameters
	$BINPATH/postinstall $APP $HMSDB
	RETVAL=$?
	if [ $RETVAL -ne 0 ] ; then
		echo "Postinstall failed with exit code $RETVAL"
		exit 1
	fi
fi

echo "Starting tomcat again"
sudo /etc/init.d/tomcat-9 start

echo "Installation successful"


